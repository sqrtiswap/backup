#!/bin/sh

_fail="\033[31m"
_good="\033[32m"
_rset="\033[0m"

set -e

command -v rsync > /dev/null \
	&& RSYNC='rsync' \
	|| RSYNC='openrsync'
command -v doas > /dev/null \
	&& _doas=doas \
	|| _doas=sudo

_resourcedir="$HOME"/sources/backup

backup() {
	nr_of_reports="$(grep -c "$(date +%F)" "$TODODIR"/report.txt)"
	[ "${nr_of_reports}" -lt 1 ] && todo -q report

	[ -n "$2" ] && _mntpoint="$2" || exit 1
	dirlist="${_resourcedir}"/list-backup.txt
	nr=$(grep -c '' "$dirlist")
	i=0

	while IFS= read -r d ; do
		i=$((i+1))
		"$RSYNC" -av --delete "$HOME/$d" "${_mntpoint}/" \
			&& printf "${_good}%s${_rset}\n\n" "---> Synced $i/${nr}" \
			|| exit 1
	done < "$dirlist"
	[ -f "$HOME"/mbox ] && cp -vf "$HOME"/mbox "${_mntpoint}"
}

check_bitrot() {
	checklist="${_resourcedir}"/list-bitrot.txt
	nr=$(grep -c '' "$checklist")
	i=0

	while IFS= read -r d ; do
		i=$((i+1))
		cd "$HOME"/"$d" && bitrot \
			&& printf "${_good}%s${_rset}\n\n" "---> checked bitrot $i/${nr} ($HOME/$d)" \
			|| exit 1
	done < "$checklist"
}

collect_config() {
	# collect stuff in ~/.config/
	_configdir="${_dotdir}"/.config
	mkdir -p "${_configdir}" || exit 1
	configlist="${_resourcedir}"/list-config.txt
	nr=$(grep -c '' "$configlist")
	i=0

	while IFS= read -r c ; do
		if [ -e "$HOME"/.config/"$c" ] ; then
			i=$((i+1))
			cp -R "$HOME"/.config/"$c" "${_configdir}" \
				&& printf "${_good}%s${_rset}\n" "collected $i/${nr} ($HOME/.config/$c)" \
				|| exit 1
		else
			printf "${_fail}%s${_rset}\n" "$c does not exist."
		fi
	done < "$configlist"
}

collect_home() {
	# collect stuff in ~/
	_homedir="${_dotdir}"/home
	mkdir -p "${_homedir}" || exit 1
	homelist="${_resourcedir}"/list-home.txt
	nr=$(grep -c '' "$homelist")
	i=0

	while IFS= read -r h ; do
		if [ -e "$HOME"/"$h" ] ; then
			i=$((i+1))
			cp -R "$HOME"/"$c" "${_homedir}" \
				&& printf "${_good}%s${_rset}\n" "collected $i/${nr} ($HOME/$h)" \
				|| exit 1
		else
			printf "${_fail}%s${_rset}\n" "$c does not exist."
		fi
	done < "$homelist"
}

collect_special() {
	# collect just the config from ~/.ssh/
	mkdir -p "${_homedir}"/.ssh && cp "$HOME"/.ssh/config "${_homedir}"/.ssh/config

	# dump notmuch database
	notmuch dump --output="${_homedir}"/notmuch-dump.txt
}

collect_gpg() {
	# collect just the configs from ~/.gnupg/
	_gpgdir="${_homedir}"/.gpg
	mkdir -p "${_gpgdir}" || exit 1
	gpglist="${_resourcedir}"/list-gpg.txt
	nr=$(grep -c '' "$gpglist")
	i=0

	while IFS= read -r g ; do
		if [ -e "$HOME"/.gnupg/"$g" ] ; then
			i=$((i+1))
			cp "$HOME"/.gnupg/"$g" "${_gpgdir}" \
				&& printf "${_good}%s${_rset}\n" "collected $i/${nr} ($HOME/.gnupg/$g)" \
				|| exit 1
		else
			printf "${_fail}%s${_rset}\n" "$g does not exist."
		fi
	done < "$gpglist"
}

collect_privconfig() {
	echo "Start collecting privileged configurations:"
	_privdir="${_dotdir}"/PRIVILEGED

	mkdir -p "${_privdir}"/etc/ \
		&& echo "----> [1/4] ${_privdir} created." \
		|| exit 1

	"${_doas}" cp \
		/etc/doas.conf \
		/etc/freshclam.conf \
		/etc/fstab \
		"${_privdir}"/etc/ \
		&& echo "----> [2/4] General /etc/ collected." \
		|| exit 1

	if [ "$(uname -s)" = "OpenBSD" ] ; then
		"${_doas}" cp \
			/etc/login.conf \
			/etc/man.conf \
			/etc/mixerctl.conf \
			/etc/ntpd.conf \
			/etc/sndioctl.conf \
			/etc/sysclean.ignore \
			/etc/wpa_supplicant.conf \
			/etc/wsconsctl.conf \
			"${_privdir}"/etc/ \
			&& echo "--------> [1/3] OpenBSD specific /etc/ collected." \
			|| exit 1

		mkdir -p "${_privdir}"/etc/X11/xenodm/ \
			&& echo "--------> [2/3] Xenocara's directory created." \
			|| exit 1

		"${_doas}" cp \
			/etc/X11/xenodm/Xresources* \
			/etc/X11/xenodm/Xsetup_0 \
			/etc/X11/xenodm/GiveConsole \
			"${_privdir}"/etc/X11/xenodm/ \
			&& echo "--------> [3/3] /etc/X11/xenodm/ collected." \
			|| exit 1

		echo "----> [3/4] OpenBSD specific privileged configs collected."
	elif [ "$(awk -F "(\"| )" 'NR == 1 { print $2 }' /etc/os-release)" = "Fedora" ] ; then
		"${_doas}" cp \
			/etc/man_db.conf \
			"${_privdir}"/etc/ \
			&& echo "----> [3/4] Fedora specific /etc/ collected." \
			|| exit 1
	else
		echo "OS is unknown. Aborting..." && exit 1
	fi

	"${_doas}" chown -R "$USER:$USER" "${_privdir}" \
		&& echo "----> [4/4] changed ownership of privileged configs." \
		|| exit 1
}

collect_installs() {
	printf "%s\n" "---> Start collecting installed packages:"
	_installdir="${_dotdir}"/installed_packages
	mkdir -p "${_installdir}" \
		&& printf "${_good}%s${_rset}\n" "Created ${_installdir}" \
		|| exit 1

	if [ "$(uname -s)" = "OpenBSD" ] ; then
		pkg_info -tz >> "${_installdir}"/openbsd_pkgs.txt \
			&& printf "${_good}%s${_rset}\n" "collected OpenBSD packages" \
			|| exit 1
	elif [ "$(awk -F "(\"| )" 'NR == 1 { print $2 }' /etc/os-release)" = "Fedora" ] ; then
		dnf history userinstalled >> "${_installdir}"/fedora_pkgs.txt \
			&& printf "${_good}%s${_rset}\n" "collected Fedora packages" \
			|| exit 1
		flatpak list --app >> "${_installdir}"/flatpaks.txt \
			&& printf "${_good}%s${_rset}\n" "collected Flatpaks packages" \
			|| exit 1
	else
		printf "${_fail}%s${_rset}\n" "OS is unknown. Aborting..." && exit 1
	fi
}

finish_dotfiles() {
	cd "${_dotdir}" && du -d1 | sort -h
}

prepare_dotfiles() {
	_dotdir="$HOME"/dotfiles/"$(date +%F)"
	if [ -d "${_dotdir}" ] ; then
		echo "${_dotdir} already exists. Do some clean-up!"
		exit 1
	else
		mkdir -p "${_dotdir}"
		printf "${_good}%s${_rset}\n" "Created ${_dotdir}"
	fi
	mv "$HOME"/Downloads/bookmarks.html "${_dotdir}"/torbookmarks.html
	mv "$HOME"/Downloads/bookmarks_"$(date +%d_%m_%Y)".html "${_dotdir}"/chromebookmarks.html
}

usage() { cat << USAGE
${0##*/} - a selection of scripts for reliable backups
usage: ${0##*/}	all [dir] -> backup all directories to [dir]
		bitrot    -> check for bitrot in selected directories
		dotfiles  -> collect dotfiles"
USAGE
	exit 1
}

set +e

case $1 in
all)
	backup "$@"
	;;
bitrot)
	check_bitrot
	;;
dotfiles)
	prepare_dotfiles
	collect_config
	collect_home
	collect_special
	collect_gpg
	collect_privconfig
	collect_installs
	finish_dotfiles
	;;
*)
	usage
	;;
esac
